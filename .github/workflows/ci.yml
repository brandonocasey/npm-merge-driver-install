name: ci

on: [push]

jobs:
  ci:
    strategy:
      fail-fast: false
      matrix:
        node: [20, 22, 24]
        os: [ubuntu-latest, macos-latest, windows-latest, wsl-ubuntu]
    runs-on: ${{ matrix.os == 'wsl-ubuntu' && 'windows-latest' || matrix.os }}
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: configure git line endings
        run: git config --global core.autocrlf false

      - name: setup wsl
        if: matrix.os == 'wsl-ubuntu'
        uses: Vampire/setup-wsl@v6
        with:
          distribution: Ubuntu-22.04

      - name: restore nvm cache (wsl)
        if: matrix.os == 'wsl-ubuntu'
        id: cache-nvm
        uses: actions/cache/restore@v4
        with:
          path: nvm-cache.tar.gz
          key: wsl-nvm-${{ matrix.node }}-${{ hashFiles('.nvmrc', '.node-version') }}
          restore-keys: |
            wsl-nvm-${{ matrix.node }}-
            wsl-nvm-

      - name: extract nvm cache (wsl)
        if: matrix.os == 'wsl-ubuntu' && steps.cache-nvm.outputs.cache-hit == 'true'
        shell: wsl-bash {0}
        run: |
          if [ -f /mnt/d/a/npm-merge-driver-install/npm-merge-driver-install/nvm-cache.tar.gz ]; then
            tar -xzf /mnt/d/a/npm-merge-driver-install/npm-merge-driver-install/nvm-cache.tar.gz -C "$HOME"
          fi

      - name: setup node (wsl)
        if: matrix.os == 'wsl-ubuntu'
        shell: wsl-bash {0}
        run: |
          set -eo pipefail
          export NVM_DIR="$HOME/.nvm"
          if [ ! -s "$NVM_DIR/nvm.sh" ]; then
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
          fi
          . "$NVM_DIR/nvm.sh" --no-use
          nvm install ${{ matrix.node }}

          # Create profile script to auto-load nvm and use correct node version
          cat > ~/.bash_profile << 'EOF'
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" --no-use
          nvm use ${{ matrix.node }} >/dev/null 2>&1
          EOF

      - name: setup node
        if: matrix.os != 'wsl-ubuntu'
        uses: actions/setup-node@v4
        with:
          node-version: "${{matrix.node}}"
          cache: npm

      - name: remove problem matchers
        run: |
          echo "::remove-matcher owner=eslint-compact::"
          echo "::remove-matcher owner=eslint-stylish::"
          echo "::remove-matcher owner=tsc::"

      # GitHub Actions doesn't support matrix variables in the shell property
      # See: https://github.com/actions/runner/issues/444
      # Therefore we need separate steps for WSL vs non-WSL platforms
      - name: npm install (wsl)
        if: matrix.os == 'wsl-ubuntu'
        shell: wsl-bash {0}
        run: npm i --prefer-offline --no-audit

      - name: npm install
        if: matrix.os != 'wsl-ubuntu'
        run: npm i --prefer-offline --no-audit

      - name: run npm test (wsl)
        if: matrix.os == 'wsl-ubuntu'
        shell: wsl-bash {0}
        run: npm run test

      - name: create nvm cache archive (wsl)
        if: matrix.os == 'wsl-ubuntu' && steps.cache-nvm.outputs.cache-hit != 'true'
        shell: wsl-bash {0}
        run: tar -czf /mnt/d/a/npm-merge-driver-install/npm-merge-driver-install/nvm-cache.tar.gz -C "$HOME" .nvm

      - name: save nvm cache (wsl)
        if: matrix.os == 'wsl-ubuntu' && steps.cache-nvm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: nvm-cache.tar.gz
          key: wsl-nvm-${{ matrix.node }}-${{ hashFiles('.nvmrc', '.node-version') }}

      - name: run npm test
        if: matrix.os != 'wsl-ubuntu'
        run: npm run test
